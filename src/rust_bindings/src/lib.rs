#![allow(non_camel_case_types)]
#![allow(non_snake_case)]
#![allow(dead_code)]
#![allow(non_upper_case_globals)]

extern crate link_cplusplus;

mod bindings {
    include!(concat!(env!("OUT_DIR"), "/bindings.rs"));
}

pub fn create_discriminant<const N: usize>(seed: &[u8], output: &mut [u8; N]) {
    // SAFETY: The length is guaranteed to match the actual length of the char pointer.
    unsafe {
        let ptr = bindings::create_discriminant_wrapper(seed.as_ptr(), seed.len(), N as i32);
        output.copy_from_slice(std::slice::from_raw_parts(ptr as *const u8, N));
        bindings::free(ptr as *mut std::ffi::c_void);
    }
}

pub fn verify_n_wesolowski(
    discriminant: &[u8],
    x_s: &[u8],
    proof: &[u8],
    num_iterations: u64,
    disc_size_bits: u64,
    recursion: u64,
) -> bool {
    // SAFETY: The lengths are guaranteed to match the actual lengths of the char pointers.
    unsafe {
        let value = bindings::verify_n_wesolowski_wrapper(
            discriminant.as_ptr() as *const std::ffi::c_char,
            discriminant.len(),
            x_s.as_ptr() as *const std::ffi::c_char,
            x_s.len(),
            proof.as_ptr() as *const std::ffi::c_char,
            proof.len(),
            num_iterations,
            disc_size_bits,
            recursion,
        );
        value == 1
    }
}

#[cfg(test)]
mod tests {
    use hex_literal::hex;
    use rand::{Rng, SeedableRng};
    use rand_chacha::ChaCha8Rng;

    use super::*;

    #[test]
    fn test_create_discriminant() {
        let mut discriminants = Vec::new();
        let mut seeds = [[0; 10]; 10];

        for (i, seed) in seeds.iter_mut().enumerate() {
            let mut rng = ChaCha8Rng::seed_from_u64(i as u64);

            rng.fill(seed);

            let mut discriminant = [0; 512];
            create_discriminant(seed, &mut discriminant);

            discriminants.push(hex::encode(discriminant));
        }

        let expected = [
            hex!("2d30783961386561663963353264396135663164623634386364663762636430346233356362316163346634323163393738666136316665313334346239376434313939646266663730306432346537636663306237383565346238623830323364633439663065393032323766373466353432333430333261633333383138373966000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
            hex!("2d3078623139336364623032663163323631356132353762393839333365653064323431353761633566386334363737346435643633353032326536653662643366373337323839383036366332613430666132313164316466386334356362393563303265333665663837386263363733323534373364396330626233346230343700000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
            hex!("2d3078626235626431396165353065666539386235616335366336393435336139356539326463313662623462323832346537336233396239646230613037376661333366633265373735393538616631346636373561303731626635336631633232663930636362643435366532323931323736393531383330646261396463616600000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
            hex!("2d3078613165393362386632653962306664336231333235666265343036303166353565326166626463363136313430396330616666383733376237323133643764373163616232316666633833613062366435626465656532666463626262333466626338666330623433393931353037356166613966666163386262316233333700000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
            hex!("2d3078663261313066373031343866623330653461313663346564613434636330663939313763623963326434363039323664353961343038333138343732653263666435393731393361613538653166646363633661653661346438356263396232376637373536376562653934666365646266353330613630666637303966643700000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
            hex!("2d3078383466373436336332643733333736633164313938316166306232396664303664316634636633323961643763363038366330636534393037623437656262643061323336623665633933646366373930663238343163646335363861666463666264333261623335346338666533616161356639623536363433306632656600000000000000000000000000000000000000000000000000000000003f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
            hex!("2d3078636465313635636434353662633161653133346262623733366362323438393030363566343662643033623237666335363162373237643861663232666466326136323135376231636565396165633138393133313430386563363538353932663062363339306563663964366162353566383563643162633464626234656600000000000000000000000000000000000000000000000000000000003f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
            hex!("2d3078616332643038333032323062306361653466623330376331666530623035303937323036636337386330393434393766343663333237633636306332383761613432303637393861646138306630333966633330393438616337616565656266636261393139653663326561386432366235386138323261633738373536643700000000000000000000000000000000000000000000000000000000003f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
            hex!("2d3078646635353632346461623133353732636561393064376533663766616439376162356230663162333530643531626230656530363065313534326461353661333730613238303361333539303964373832616138356434656263326331313935616463393839656136373363393635386664363037633739316538663936653700000000000000000000000000000000000000000000000000000000003f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
            hex!("2d30786662346335666466353339303535326465643863663930363435306535616438626562396335386234353938656233636534666562343864646434356463623630393033613332666632663638373562373764653538613732613237326536643336653935623061633466653134643066303931326534636635343864386566000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000130000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001300"),
        ];

        for i in 0..10 {
            assert_eq!(
                discriminants[i],
                hex::encode(expected[i]),
                "Discriminant {} does not match (seed is {})",
                i,
                hex::encode(seeds[i])
            );
        }
    }
}
